"use strict";const validCoupons={christmas2020:15,thanksgivingday:30,test:20};let coupon;const templateCartItem=document.getElementById("template-cart-item").content,templateCartFooter=document.getElementById("template-cart-footer").content,templateCartCheckout=document.getElementById("template-cart-checkout").content,templateCartPurchase=document.getElementById("template-cart-purchase").content,cartItems=document.getElementById("cart-items"),cartMainContainer=document.getElementById("cart-container"),fragment=document.createDocumentFragment(),finalPriceSelector="div.d-flex div.text-truncate",itemTitleSelector="div.fw-bold.mb-1",itemMainRowSelector=".row",inputUnitSelector='input[name="quantity"]',itemImageSelector="img",titleContainerSelector=".mx-2",footerContainerSelector=".col-12.col-sm-11.col-md-10.py-5.border-bottom.ff-lato-4.mx-auto",cartLabelSelector="span#cart-label",savedLabelSelector="span#saved-label",footerButtonsSelector="button.btn.btn-primary.ff-lato-7",paymentFigureSelector="figure.my-2.me-2.overflow-hidden.rounded.h-pointer",itemSpanSelector=".h-pointer.ps-1.ps-sm-0.pe-1.pe-sm-2",inputReduceSelector='input[name="reducequantity"]',inputIncreaseSelector='input[name="increasequantity"]',checkoutCalculationSeletor="div.text-break.text-truncate-2 span",checkoutItemContainerSelector="div.col-xs-12.col-md-8.my-2",cartLabelsContainerSelector=".col-10",goBackBtnSelector="div.col-12.text-primary.fs-5.mb-3",discountsLabelSelector="span#discounts-label",shippingLabelSelector="span#shipping-label",itemUnitsSelector="div.text-center span.text-muted",unitsContainerSelector=".border.p-2",couponBoxSelector="div.border.p-1.rounded",firstCouponSpanSelector="span";let itemsToBuy=localStorage.getItem("cart"),checkoutStatus=JSON.parse(localStorage.getItem("checkoutStatus"))||{inCart:!0,chosenPaymentMethod:"paypal",activeCoupon:void 0},savedForLaterItems=JSON.parse(localStorage.getItem("savedForLater"))||{};if(null===itemsToBuy)renderEmptyCart();else try{itemsToBuy=JSON.parse(itemsToBuy),!1===checkoutStatus.inCart?renderCheckout(itemsToBuy,checkoutStatus.chosenPaymentMethod):(renderCartItems(itemsToBuy),renderCartFooter(itemsToBuy))}catch(e){console.log(e)}if(0===Object.entries(savedForLaterItems).length)cartMainContainer.querySelector(savedLabelSelector).textContent="(0)";else try{updateLabel(savedForLaterItems)}catch(e){console.log(e)}function renderEmptyCart(){cartItems.innerHTML="";const e=document.createElement("h1");e.classList.add("my-4","p-2","fs-4"),e.textContent="Your shopping cart is empty";const t=document.createElement("div");t.classList.add("my-5");const a=document.createElement("a");a.setAttribute("href","../shop/shop.html");const o=document.createElement("button");o.classList.add("btn","btn-primary","ff-lato-7","fs-5","col-md-8","col-lg-4"),o.textContent="Check catalog",a.appendChild(o),t.appendChild(a),fragment.appendChild(e),fragment.appendChild(t),cartItems.classList.add("text-center"),cartItems.appendChild(fragment)}function renderCartItems(e){cartItems.innerHTML="",checkoutStatus.inCart=!0,localStorage.setItem("checkoutStatus",JSON.stringify(checkoutStatus)),Object.values(e).forEach(e=>{templateCartItem.querySelector(itemTitleSelector).textContent=e.title,e.quantity>1&&e.quantity<e.unitsAvailable?(templateCartItem.querySelector(inputReduceSelector).removeAttribute("disabled"),templateCartItem.querySelector(inputIncreaseSelector).removeAttribute("disabled"),templateCartItem.querySelector(inputUnitSelector).value=e.quantity):e.quantity>=e.unitsAvailable?(templateCartItem.querySelector(inputReduceSelector).removeAttribute("disabled"),templateCartItem.querySelector(inputIncreaseSelector).setAttribute("disabled",""),templateCartItem.querySelector(inputUnitSelector).value=e.unitsAvailable):(templateCartItem.querySelector(inputReduceSelector).setAttribute("disabled",""),templateCartItem.querySelector(inputUnitSelector).value=e.quantity),templateCartItem.querySelector(itemUnitsSelector).textContent=`${e.unitsAvailable} available`,templateCartItem.querySelector(itemMainRowSelector).dataset.id=e.id,templateCartItem.querySelector(finalPriceSelector).textContent=(e.quantity*e.finalPrice).toFixed(2);const t=templateCartItem.querySelector(itemImageSelector),a=e.title.toLowerCase().replaceAll(" ","-");if(t.setAttribute("src",e.thumnailUrl),t.setAttribute("alt",a),e.hasFreeShipping){const e=document.createElement("div");e.classList.add("text-green-5","mb-1");const t=document.createElement("i");t.classList.add("fas","fa-truck","me-1");const a=document.createElement("span");a.classList.add("fw-bold"),a.textContent="Free shipping",e.appendChild(t),e.appendChild(a),templateCartItem.querySelector(titleContainerSelector).appendChild(e)}const o=templateCartItem.cloneNode(!0);if(fragment.appendChild(o),e.hasFreeShipping){const e=templateCartItem.querySelector(titleContainerSelector);e.removeChild(e.lastChild)}}),cartItems.appendChild(fragment),footerCalculator(e)}function renderCartFooter(e){footerHasBeenCreated();const{rfinalPrice:t,rshipping:a,rhasfreeshipping:o,rpaymentMethod:r,rcoupondiscount:n,rcoupondiscountpercentage:c}=footerCalculator(e);templateCartFooter.querySelector(finalPriceSelector).textContent=t.toFixed(2);const i=templateCartFooter.querySelector(shippingLabelSelector);o?(i.classList.add("text-green-5"),i.textContent="Free"):i.textContent=`$${a.toFixed(2)}`,templateCartFooter.querySelectorAll(finalPriceSelector)[2].textContent=r.toFixed(2),templateCartFooter.querySelector(discountsLabelSelector).textContent=`-$${n.toFixed(2)} (${c}%)`,templateCartFooter.querySelectorAll(finalPriceSelector)[3].textContent=(t+a+r-n).toFixed(2);const l=templateCartFooter.cloneNode(!0);fragment.appendChild(l),cartMainContainer.appendChild(fragment);const s=document.querySelectorAll(footerButtonsSelector)[1],u=document.querySelectorAll(footerButtonsSelector)[0];s.addEventListener("click",()=>{renderCheckout(itemsToBuy,checkoutStatus.chosenPaymentMethod)}),u.addEventListener("click",()=>{resetCart()}),cartMainContainer.querySelectorAll(paymentFigureSelector).forEach(e=>{e.classList.remove("border","border-2","border-primary")}),cartMainContainer.querySelector(`img[data-method="${checkoutStatus.chosenPaymentMethod}"]`).parentNode.classList.add("border","border-2","border-primary"),(coupon=document.getElementById("applyCoupon"))&&coupon.parentNode.addEventListener("submit",e=>{e.preventDefault(),checkCoupon()}),checkoutStatus.activeCoupon&&checkCoupon()}function cartManager(e){switch(e.target.name){case"reducequantity":case"increasequantity":e.target.parentNode.addEventListener("submit",e=>{e.preventDefault()});const t=itemsToBuy[e.target.closest(itemMainRowSelector).dataset.id];"reducequantity"===e.target.name?t.quantity--:t.quantity++,itemsToBuy[e.target.closest(itemMainRowSelector).dataset.id]={...t},localStorage.setItem("cart",JSON.stringify(itemsToBuy)),updateCartContent(e);break;case"quantity":const a=itemsToBuy[e.target.closest(itemMainRowSelector).dataset.id].unitsAvailable;let o;e.target.addEventListener("keyup",()=>{o=o>=0&&o<=a&&null!==o?parseInt(e.target.value,10):o>a?a:0,itemsToBuy[e.target.closest(itemMainRowSelector).dataset.id].quantity=o,localStorage.setItem("cart",JSON.stringify(itemsToBuy)),updateCartContent(e)})}if("applyCouponBtn"!==e.target.parentNode.id&&"applyCouponBtn"!==e.target.id||checkCoupon(),e.target.matches(itemSpanSelector)&&"Remove"===e.target.textContent&&(delete itemsToBuy[e.target.closest(itemMainRowSelector).dataset.id],localStorage.setItem("cart",JSON.stringify(itemsToBuy)),0===Object.values(itemsToBuy).length?resetCart():(renderCartItems(itemsToBuy),renderCartFooter(itemsToBuy))),e.target.matches(itemSpanSelector)&&"Buy now"===e.target.textContent){renderCheckout([itemsToBuy[e.target.closest(itemMainRowSelector).dataset.id]],checkoutStatus.chosenPaymentMethod)}if(e.target.matches(itemSpanSelector)&&"Save for later"===e.target.textContent){const t=e.target.closest(itemMainRowSelector).dataset.id,a=itemsToBuy[t];savedForLaterItems[t]={...a},localStorage.setItem("savedForLater",JSON.stringify(savedForLaterItems)),updateLabel(savedForLaterItems)}if(e.target.parentNode.matches(paymentFigureSelector))switch(cartMainContainer.querySelectorAll(paymentFigureSelector).forEach(e=>{e.classList.remove("border","border-2","border-primary")}),e.target.parentNode.classList.add("border","border-2","border-primary"),e.target.dataset.method){case"paypal":checkoutStatus.chosenPaymentMethod="paypal",updateCartContent(e);break;case"mastercard":checkoutStatus.chosenPaymentMethod="mastercard",updateCartContent(e);break;case"visaandmaster":checkoutStatus.chosenPaymentMethod="visaandmaster",updateCartContent(e);break;case"paysafecard":checkoutStatus.chosenPaymentMethod="paysafecard",updateCartContent(e);break;case"klarna":checkoutStatus.chosenPaymentMethod="klarna",updateCartContent(e)}e.stopPropagation()}function updateCartContent(e){const t=itemsToBuy[e.target.closest(itemMainRowSelector).dataset.id];if(void 0!==t){const a=t.quantity,o=t.unitsAvailable,r=t.finalPrice,n=cartItems.querySelector('.row[data-id="'+t.id+'"]');a>1&&a<o?(n.querySelector(inputReduceSelector).removeAttribute("disabled"),n.querySelector(inputIncreaseSelector).removeAttribute("disabled"),e.target.closest(unitsContainerSelector).querySelector(inputUnitSelector).value=a):a>=o?(n.querySelector(inputReduceSelector).removeAttribute("disabled"),n.querySelector(inputIncreaseSelector).setAttribute("disabled",""),e.target.closest(unitsContainerSelector).querySelector(inputUnitSelector).value=o):(n.querySelector(inputReduceSelector).setAttribute("disabled",""),e.target.closest(unitsContainerSelector).querySelector(inputUnitSelector).value=a),e.target.closest(itemMainRowSelector).querySelector(finalPriceSelector).textContent=(a*r).toFixed(2)}const{rfinalPrice:a,rshipping:o,rhasfreeshipping:r,rpaymentMethod:n,rcoupondiscount:c,rcoupondiscountpercentage:i}=footerCalculator(itemsToBuy),l=cartMainContainer.querySelector(footerContainerSelector);l.querySelector(finalPriceSelector).textContent=a.toFixed(2);const s=l.querySelector(shippingLabelSelector);r?(s.classList.add("text-green-5"),s.textContent="Free"):s.textContent=`$${o.toFixed(2)}`,l.querySelectorAll(finalPriceSelector)[2].textContent=n.toFixed(2),l.querySelector(discountsLabelSelector).textContent=`-$${c.toFixed(2)} (${i}%)`,l.querySelectorAll(finalPriceSelector)[3].textContent=(a+o+n-c).toFixed(2)}function footerCalculator(e){const t=Object.values(e).reduce((e,{quantity:t})=>e+t,0),a=Object.values(e).reduce((e,{quantity:t,finalPrice:a})=>e+t*a,0),o=Object.values(e).reduce((e,{quantity:t,price:a})=>e+t*a,0);let r=!1,n=Object.values(e).reduce((e,{hasFreeShipping:t})=>(t||(e+=50),e),0);0===n&&(r=!0),cartMainContainer.querySelector(cartLabelSelector).textContent=`(${t})`;const c=checkoutStatus.chosenPaymentMethod;let[i,l,s]=[0,0,0];switch(c){case"paypal":i=15;break;case"mastercard":i=10;break;case"visaandmaster":i=21;break;case"paysafecard":i=8;break;case"klarna":i=2}return i=a*i/100,localStorage.setItem("checkoutStatus",JSON.stringify(checkoutStatus)),checkoutStatus.activeCoupon&&(l=a*validCoupons[checkoutStatus.activeCoupon]/100,s=validCoupons[checkoutStatus.activeCoupon]),{rfinalPrice:a,rshipping:n,rhasfreeshipping:r,rquantity:t,rpaymentMethod:i,rprice:o,rcoupondiscount:l,rcoupondiscountpercentage:s}}function resetCart(){localStorage.removeItem("cart"),cartMainContainer.querySelector(cartLabelSelector).textContent="(0)",cartMainContainer.removeChild(cartMainContainer.lastElementChild),renderEmptyCart()}function renderCheckout(e,t){cartItems.innerHTML="",footerHasBeenCreated();const{rfinalPrice:a,rshipping:o,rpaymentMethod:r,rprice:n,rcoupondiscount:c}=footerCalculator(e,t),i=document.createElement("div");i.classList.add("col-12","text-primary","fs-5","mb-3");const l=document.createElement("button");l.classList.add("border-0","bg-transparent","ms-4");const s=document.createElement("span");s.classList.add("h-pointer"),s.textContent="Go back";const u=document.createElement("span");u.classList.add("p-1","mx-2","rounded","bg-primary","text-white","rounded");const d=document.createElement("i");d.classList.add("fas","fa-chevron-left","fa-fw"),l.addEventListener("click",e=>{cartMainContainer.querySelector(cartLabelsContainerSelector).classList.remove("d-none"),cartMainContainer.removeChild(cartMainContainer.querySelector(goBackBtnSelector)),renderCartItems(itemsToBuy),renderCartFooter(itemsToBuy),e.stopPropagation()}),u.appendChild(d),s.appendChild(u),s.insertBefore(u,s.childNodes[0]),l.appendChild(s),i.appendChild(l),cartMainContainer.insertBefore(i,cartMainContainer.childNodes[0]),cartMainContainer.querySelector(cartLabelsContainerSelector).classList.add("d-none");const m=templateCartCheckout.querySelector(checkoutItemContainerSelector);Object.values(e).forEach(e=>{const t=document.createElement("div");t.classList.add("d-flex","flex-column","flex-sm-row","justify-content-between","text-center","my-1");const a=document.createElement("div");a.classList.add("text-truncate","w-checkout-item-title");const o=document.createElement("span");o.classList.add("fw-bold"),o.textContent=e.quantity;const r=document.createElement("span");r.textContent=" - ";const n=document.createElement("span");n.textContent=e.title;const c=document.createElement("div");c.classList.add("text-truncate","w-checkout-item-price","pe-auto","pe-sm-2"),c.textContent=`$${(e.quantity*e.finalPrice).toFixed(2)}`,a.appendChild(o),a.appendChild(r),a.appendChild(n),t.appendChild(a),t.appendChild(c),m.appendChild(t)});const p=Math.ceil(100*(n-(a-c))/(n+o+r));templateCartCheckout.querySelectorAll(checkoutCalculationSeletor)[1].textContent=`$${(n+r+o).toFixed(2)}`,templateCartCheckout.querySelectorAll(checkoutCalculationSeletor)[2].textContent=`-$${(n-(a-c)).toFixed(2)}`,templateCartCheckout.querySelectorAll(checkoutCalculationSeletor)[3].textContent=`(${p}%)`,templateCartCheckout.querySelectorAll(checkoutCalculationSeletor)[4].textContent=`$${(a+o+r-c).toFixed(2)}`;const S=templateCartCheckout.cloneNode(!0);fragment.appendChild(S),cartItems.appendChild(fragment),m.innerHTML="",document.querySelector(footerButtonsSelector).addEventListener("click",t=>{t.stopPropagation(),renderPurchaseFinished(e)}),checkoutStatus.inCart=!1,localStorage.setItem("checkoutStatus",JSON.stringify(checkoutStatus))}function footerHasBeenCreated(){return null!==cartMainContainer.querySelector(footerContainerSelector)&&(cartMainContainer.removeChild(cartMainContainer.lastElementChild),!0)}function updateLabel(e){const t=Object.values(e).reduce((e,{quantity:t})=>e+t,0);cartMainContainer.querySelector(savedLabelSelector).textContent=`(${t})`}function checkCoupon(){const e=cartMainContainer.querySelector(couponBoxSelector),t=e.querySelector(firstCouponSpanSelector);validCoupons[coupon.value.toLowerCase()]?buildDiscountTag(t):checkoutStatus.activeCoupon?(coupon.value=checkoutStatus.activeCoupon,buildDiscountTag(t)):(e.querySelector(firstCouponSpanSelector).textContent="Sorry, The Coupon Code you entered is invalid. Please check and try again!",checkoutStatus.activeCoupon=void 0,localStorage.setItem("checkoutStatus",JSON.stringify(checkoutStatus)))}function buildDiscountTag(e){const t=document.querySelector(footerContainerSelector);e.textContent=`${validCoupons[coupon.value.toLowerCase()]}% - ${coupon.value.toLowerCase()}`;const a=document.createElement("span");a.classList.add("sel-primary","mx-1");const o=document.createElement("i");o.classList.add("fas","fa-times","fa-fw"),a.appendChild(o),a.addEventListener("click",a=>{coupon.value="",e.innerHTML="No coupons applied",checkoutStatus.activeCoupon=void 0,localStorage.setItem("checkoutStatus",JSON.stringify(checkoutStatus));const{rfinalPrice:o,rshipping:r,rpaymentMethod:n,rcoupondiscount:c}=footerCalculator(itemsToBuy);document.querySelector(discountsLabelSelector).textContent="-$0.00 (0%)",t.querySelectorAll(finalPriceSelector)[3].textContent=(o+r+n-c).toFixed(2),a.stopPropagation()}),e.appendChild(a),checkoutStatus.activeCoupon=coupon.value.toLowerCase(),localStorage.setItem("checkoutStatus",JSON.stringify(checkoutStatus));const{rfinalPrice:r,rshipping:n,rpaymentMethod:c,rcoupondiscount:i,rcoupondiscountpercentage:l}=footerCalculator(itemsToBuy);document.querySelector(discountsLabelSelector).textContent=`-$${i.toFixed(2)} (${l}%)`,t.querySelectorAll(finalPriceSelector)[3].textContent=(r+n+c-i).toFixed(2),coupon.value=""}function renderPurchaseFinished(e){cartMainContainer.innerHTML="",cartMainContainer.classList.remove("my-5"),cartMainContainer.classList.add("h-100"),cartItems.classList.add("h-100");const t=templateCartPurchase.cloneNode(!0);fragment.appendChild(t),cartMainContainer.appendChild(fragment),checkoutStatus.inCart=!0,localStorage.setItem("checkoutStatus",JSON.stringify(checkoutStatus)),Object.values(e).forEach(e=>{itemsToBuy[e.id]&&delete itemsToBuy[e.id],savedForLaterItems[e.id]&&delete savedForLaterItems[e.id]}),localStorage.setItem("cart",JSON.stringify(itemsToBuy)),localStorage.setItem("savedForLater",JSON.stringify(savedForLaterItems)),0===Object.values(itemsToBuy).length&&localStorage.removeItem("cart"),0===Object.values(savedForLaterItems).length&&localStorage.removeItem("savedForLater")}cartMainContainer.addEventListener("click",e=>{cartManager(e)});
